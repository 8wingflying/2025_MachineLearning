# 時間序列異常檢測_股票分析
- 在金融數據中，我們通常針對 「收益率 (Returns)」、「波動率 (Volatility)」 或 「成交量突變 (Volume Shock)」 進行異常檢測。
- 這能幫您捕捉到黑天鵝事件、財報暴雷或主力異常拉抬。
- 核心策略：特徵工程 (Feature Engineering)
  - 我們不將「收盤價」直接丟給模型，而是構建以下三個特徵給 Isolation Forest 學習：
    - 日漲跌幅 (Daily Return): 捕捉價格的劇烈變動。
    - 5日波動率 (Rolling Volatility): 捕捉市場情緒的不穩定（風險）。
    - 相對成交量 (Relative Volume): 當日成交量 / 過去 20 日平均成交量。這能捕捉「爆量」行為。
```python
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.ensemble import IsolationForest

# ==========================================
# 1. 取得股票數據
# ==========================================
# 下載 NVIDIA (NVDA) 過去 5年的數據作為範例
ticker = "NVDA"
df = yf.download(ticker, start="2020-01-01", end="2025-12-01")

# 確保數據不為空
if df.empty:
    raise ValueError("未下載到數據，請檢查股票代碼或網絡連接。")

# 為了方便處理，只取 Close 和 Volume，並處理 MultiIndex (如果有的話)
df = df[['Close', 'Volume']].copy()
if isinstance(df.columns, pd.MultiIndex):
    df.columns = df.columns.get_level_values(0)

# ==========================================
# 2. 特徵工程 (關鍵步驟)
# ==========================================
# Feature 1: 日漲跌幅 (Daily Returns)
df['Return'] = df['Close'].pct_change()

# Feature 2: 5日滾動波動率 (Volatility) - 衡量風險
df['Volatility'] = df['Return'].rolling(window=5).std()

# Feature 3: 相對成交量 (Volume Ratio) - 衡量熱度
# 當日成交量 / 過去 20 日平均成交量 (若大於 1 代表放量)
df['Vol_Ratio'] = df['Volume'] / df['Volume'].rolling(window=20).mean()

# 清除 NaN (因為 rolling 會產生空值)
df.dropna(inplace=True)

# 準備訓練數據 (只選取我們計算出的特徵，而非原始股價)
features = ['Return', 'Volatility', 'Vol_Ratio']
X = df[features]

# ==========================================
# 3. 異常檢測模型
# ==========================================
# contamination=0.03 代表我們預期大約有 3% 的交易日是異常的 (極端行情)
model = IsolationForest(contamination=0.03, random_state=42)
df['anomaly'] = model.fit_predict(X)

# 篩選出異常點 (-1 為異常)
anomalies = df[df['anomaly'] == -1]

# ==========================================
# 4. 視覺化結果
# ==========================================
fig, ax1 = plt.subplots(figsize=(14, 7))

# 繪製股價走勢
ax1.plot(df.index, df['Close'], color='#1f77b4', alpha=0.6, label='Stock Price')
ax1.set_ylabel('Price ($)', color='#1f77b4', fontsize=12)
ax1.tick_params(axis='y', labelcolor='#1f77b4')

# 標記異常點
# 我們在股價圖上標出這些異常發生的時間點
ax1.scatter(anomalies.index, anomalies['Close'], color='red', s=60, label='Anomaly Detected', zorder=5)

plt.title(f'Anomaly Detection for {ticker}: Price Shocks & Volume Spikes', fontsize=16)
plt.grid(True, linestyle='--', alpha=0.5)
plt.legend(loc='upper left')

plt.show()

# ==========================================
# 5. 分析異常點詳細資訊
# ==========================================
print(f"總共檢測到 {len(anomalies)} 個異常交易日。")
print("\n部分異常交易日詳情 (按日期排序):")
# 顯示日期、收盤價、漲跌幅、以及相對成交量
print(anomalies[['Close', 'Return', 'Vol_Ratio']].tail(10))
```
