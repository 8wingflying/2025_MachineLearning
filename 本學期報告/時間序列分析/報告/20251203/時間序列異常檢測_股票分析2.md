# æ™‚é–“åºåˆ—ç•°å¸¸æª¢æ¸¬_è‚¡ç¥¨åˆ†æ2
- å°‡é€™å€‹è…³æœ¬æ”¹å¯«æˆä¸€å€‹è‡ªå‹•åŒ–ç›£æ§å·¥å…·
- ä¾‹å¦‚ï¼šè¼¸å…¥ä¸€å€‹è‚¡ç¥¨æ¸…å–®ï¼Œç¨‹å¼è‡ªå‹•è·‘ä¸€éï¼Œåˆ—å‡ºä»Šå¤©å‡ºç¾ã€Œç•°å¸¸è¨Šè™Ÿã€çš„è‚¡ç¥¨
- é‹ä½œé‚è¼¯ï¼š
  - è¼¸å…¥ï¼šä¸€å€‹è‚¡ç¥¨ä»£ç¢¼æ¸…å–®ï¼ˆå¯ä»¥æ˜¯ç¾è‚¡ï¼Œä¹Ÿå¯ä»¥æ˜¯å°è‚¡ï¼‰ã€‚
  - è™•ç†ï¼šç¨‹å¼æœƒè‡ªå‹•ä¸‹è¼‰æ¯ä¸€æª”è‚¡ç¥¨çš„æ­·å²æ•¸æ“šï¼Œè¨ˆç®—ç‰¹å¾µï¼ˆæ³¢å‹•ç‡ã€æˆäº¤é‡æ¯”ç‡ç­‰ï¼‰ã€‚
  - åˆ¤æ–·ï¼šåˆ©ç”¨å­¤ç«‹æ£®æ—åˆ¤æ–·ã€Œæœ€è¿‘ä¸€å€‹äº¤æ˜“æ—¥ã€çš„è¡Œç‚ºæ˜¯å¦å±¬æ–¼ç•°å¸¸ã€‚
  - è¼¸å‡ºï¼šåªåˆ—å‡ºå‡ºç¾ç•°å¸¸è¨Šè™Ÿçš„è‚¡ç¥¨ï¼Œä¸¦èªªæ˜åŸå› ï¼ˆæ˜¯çˆ†é‡ï¼Ÿé‚„æ˜¯åŠ‡çƒˆæ¼²è·Œï¼Ÿï¼‰ã€‚

```python
import yfinance as yf
import pandas as pd
import numpy as np
from sklearn.ensemble import IsolationForest
from datetime import datetime, timedelta

# ==========================================
# è¨­å®šåƒæ•¸
# ==========================================
# æƒ³è¦ç›£æ§çš„è‚¡ç¥¨æ¸…å–® (æ”¯æ´ç¾è‚¡èˆ‡å°è‚¡)
# å°è‚¡è«‹åŠ ä¸Š .TW (ä¸Šå¸‚) æˆ– .TWO (ä¸Šæ«ƒ)
TARGET_STOCKS = [
    "NVDA", "TSLA", "AAPL", "AMD",  # ç¾è‚¡
    "2330.TW", "2454.TW", "2603.TW" # å°è‚¡ (å°ç©é›», è¯ç™¼ç§‘, é•·æ¦®)
]

# ç•°å¸¸åˆ¤æ–·çš„æ•æ„Ÿåº¦ (è¶Šä½è¶Šä¸æ•æ„Ÿï¼Œå»ºè­° 0.01 - 0.05)
CONTAMINATION = 0.03 

# å›çœ‹æ•¸æ“šé•·åº¦ (ç”¨æ–¼å»ºç«‹æ¨¡å‹åŸºæº–)
LOOKBACK_DAYS = 365 

def get_stock_data(ticker):
    """ä¸‹è¼‰æ•¸æ“šä¸¦é€²è¡Œé è™•ç†"""
    start_date = (datetime.now() - timedelta(days=LOOKBACK_DAYS)).strftime('%Y-%m-%d')
    
    try:
        # ä¸‹è¼‰æ•¸æ“š (é—œé–‰é€²åº¦æ¢ä»¥ä¿æŒè¼¸å‡ºæ•´æ½”)
        df = yf.download(ticker, start=start_date, progress=False)
        
        if df.empty:
            return None

        # è™•ç† yfinance çš„ MultiIndex æ¬„ä½å•é¡Œ
        if isinstance(df.columns, pd.MultiIndex):
            df.columns = df.columns.get_level_values(0)
            
        # åªéœ€è¦ Close å’Œ Volume
        df = df[['Close', 'Volume']].copy()
        
        # ç¢ºä¿æ•¸æ“šè¶³å¤ é•·ä»¥è¨ˆç®—æ»¾å‹•ç‰¹å¾µ
        if len(df) < 30:
            return None
            
        return df
    except Exception as e:
        print(f"Error fetching {ticker}: {e}")
        return None

def calculate_features(df):
    """ç‰¹å¾µå·¥ç¨‹ï¼šå°‡åŸå§‹åƒ¹æ ¼è½‰æ›ç‚ºæ¨¡å‹å¯è®€çš„ç‰¹å¾µ"""
    data = df.copy()
    
    # 1. åƒ¹æ ¼è®ŠåŒ– (Returns)
    data['Return'] = data['Close'].pct_change()
    
    # 2. æ³¢å‹•ç‡ (Volatility - 5æ—¥æ¨™æº–å·®)
    data['Volatility'] = data['Return'].rolling(window=5).std()
    
    # 3. æˆäº¤é‡æ”¾å¤§å€æ•¸ (Relative Volume)
    # é¿å…é™¤ä»¥ 0ï¼ŒåŠ ä¸€å€‹æ¥µå°å€¼
    vol_ma = data['Volume'].rolling(window=20).mean() + 1e-9
    data['Vol_Ratio'] = data['Volume'] / vol_ma
    
    # ç§»é™¤å› ç‚º rolling ç”¢ç”Ÿçš„ NaN
    data.dropna(inplace=True)
    
    return data

def analyze_stock(ticker):
    """ä¸»åˆ†æé‚è¼¯"""
    df = get_stock_data(ticker)
    if df is None:
        return None

    # è¨ˆç®—ç‰¹å¾µ
    df_features = calculate_features(df)
    
    # å¦‚æœæ•¸æ“šè¢«åˆ‡åˆ°æ²’å‰©å¹¾ç­†ï¼Œå‰‡è·³é
    if len(df_features) < 10:
        return None

    # æº–å‚™è¨“ç·´æ•¸æ“š
    X = df_features[['Return', 'Volatility', 'Vol_Ratio']]

    # è¨“ç·´ç•°å¸¸æª¢æ¸¬æ¨¡å‹
    # n_jobs=-1 ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒåŠ é€Ÿ
    model = IsolationForest(contamination=CONTAMINATION, random_state=42, n_jobs=-1)
    
    # é æ¸¬æ•´å€‹åºåˆ— (1 æ­£å¸¸, -1 ç•°å¸¸)
    df_features['anomaly'] = model.fit_predict(X)
    
    # æˆ‘å€‘åªé—œå¿ƒã€Œæœ€æ–°ä¸€ç­†æ•¸æ“šã€(Latest Data Point) æ˜¯å¦ç•°å¸¸
    latest_row = df_features.iloc[-1]
    is_anomaly = latest_row['anomaly'] == -1
    
    result = {
        'ticker': ticker,
        'date': df_features.index[-1].strftime('%Y-%m-%d'),
        'price': latest_row['Close'],
        'change_pct': latest_row['Return'] * 100, # è½‰ç‚ºç™¾åˆ†æ¯”
        'vol_ratio': latest_row['Vol_Ratio'],
        'is_anomaly': is_anomaly
    }
    
    return result

# ==========================================
# ä¸»ç¨‹å¼åŸ·è¡Œå€
# ==========================================
if __name__ == "__main__":
    print(f"--- é–‹å§‹æƒæ {len(TARGET_STOCKS)} æª”è‚¡ç¥¨ ---")
    print(f"æƒææ—¥æœŸç¯„åœï¼šéå» {LOOKBACK_DAYS} å¤©")
    print("-" * 60)
    print(f"{'è‚¡ç¥¨ä»£è™Ÿ':<10} {'æ—¥æœŸ':<12} {'æ”¶ç›¤åƒ¹':<10} {'æ¼²è·Œå¹…%':<10} {'é‡æ¯”':<8} {'ç•°å¸¸ç‹€æ…‹'}")
    print("-" * 60)

    anomaly_list = []

    for ticker in TARGET_STOCKS:
        res = analyze_stock(ticker)
        
        if res:
            # æ ¼å¼åŒ–è¼¸å‡ºæ•¸å€¼
            status = "ğŸ”´ ç•°å¸¸è¨Šè™Ÿ" if res['is_anomaly'] else "æ­£å¸¸"
            print(f"{res['ticker']:<10} {res['date']:<12} {res['price']:<10.2f} {res['change_pct']:>7.2f}%   {res['vol_ratio']:>6.2f}   {status}")
            
            if res['is_anomaly']:
                anomaly_list.append(res)
        else:
            print(f"{ticker:<10} æ•¸æ“šä¸è¶³æˆ–ä¸‹è¼‰å¤±æ•—")

    print("-" * 60)
    print("\n--- ğŸ“Š ç•°å¸¸æƒææ‘˜è¦ ---")
    if anomaly_list:
        print(f"ä»Šæ—¥ç™¼ç¾ {len(anomaly_list)} æª”æ½›åœ¨ç•°å¸¸è‚¡ç¥¨ï¼š")
        for item in anomaly_list:
            # ç°¡å–®è¦å‰‡è§£é‡‹ç•°å¸¸åŸå› 
            reason = []
            if abs(item['change_pct']) > 3: reason.append("åƒ¹æ ¼åŠ‡çƒˆæ³¢å‹•")
            if item['vol_ratio'] > 2: reason.append("çˆ†å¤§é‡")
            if not reason: reason.append("æ³¢å‹•ç‡ç•°å¸¸") # å¯èƒ½æ˜¯ç›¤æ•´å¾ˆä¹…çªç„¶è®Šå‹•ï¼Œæˆ–æ³¢å‹•ç‡æ¥µé«˜
            
            print(f"ğŸš¨ {item['ticker']} ({item['date']}): {' & '.join(reason)} (æ¼²è·Œ: {item['change_pct']:.2f}%, é‡æ¯”: {item['vol_ratio']:.2f})")
    else:
        print("ä»Šæ—¥ç„¡ç™¼ç¾æ˜é¡¯ç•°å¸¸è¡Œç‚ºçš„è‚¡ç¥¨ã€‚")
```
