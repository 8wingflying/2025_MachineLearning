# 自動下載股票資料 + 畫出技術指標的 Python 套件教學（mplfinance 版）

> 編碼：UTF-8  
> 功能：自動下載股票歷史資料（使用 `yfinance`），計算常用技術指標，並用 `mplfinance` 畫出整合技術圖。  
> 目標：做成一個可以「重複使用」的 **小型 Python 套件**，也可以當作 CLI 使用。
> 本地端建置
  - 不同Agent工作
  - 不同技術指標分析 ==> pandas-ta | mplfinance |
    - ffn
      - https://pmorissette.github.io/ffn/
      - https://havocfuture.tw/blog/python-stock-history 
    - pandas-ta（Pandas Technical Analysis）內建 超過 150 種技術指標，涵蓋趨勢、動能、成交量、振盪、統計
    - mplfinance
    - twstock https://github.com/mlouielu/twstock
    - yahooquery https://github.com/dpguthrie/yahooquery
    - pandas-datareader https://github.com/pydata/pandas-datareader
    - FinMind
      - https://finmind.github.io/
      - https://finmind.github.io/tutor/TaiwanMarket/DataList/
      - [用 FinMind 套件取得股票資料 (一) 盤後資訊](https://yhhuang1966.blogspot.com/2024/08/python-finmind.html)
      - https://blog.jiatool.com/posts/stock_finmind/
      - [客製化看盤儀表板](https://finmind.github.io/tutor/analysis/CustomerDashboardWebServer/) ==> 用Flask
> Deployment
  - 要有認證
  - 使用streamlit建置web
  - 使用FastAPI建置
  - 製作成MCP server
---

## 1. 環境需求與安裝

### 1.1 安裝必要套件

```bash
pip install yfinance mplfinance pandas numpy pandas-ta
```

- `yfinance`：下載股票歷史資料（支援美股、台股等 Yahoo Finance 上有的代碼）。  
- `mplfinance`：金融圖（K 線、OHLC、交易量、子圖）。  
- `pandas` / `numpy`：資料處理與數值運算。  
- `pandas-ta`：技術指標計算（MACD、RSI、KD、布林通道…）。

> 註：若不想用 `pandas-ta`，也可以自行寫技術指標公式，後面會示範兩種版本。

---

## 2. 專案結構設計（小型套件風格）

這裡示範一個簡單的套件結構：

```text
stocktech/
    __init__.py
    config.py
    downloader.py
    indicators.py
    plotter.py
    cli.py        # 讓你可以 python -m stocktech ... 直接呼叫
```

- `downloader.py`：負責下載股票資料（`yfinance`）。  
- `indicators.py`：負責計算技術指標（MA、EMA、RSI、MACD、BBands…）。  
- `plotter.py`：負責用 `mplfinance` 畫圖。  
- `cli.py`：簡單命令列介面。

> 你可以把這個資料夾 `stocktech/` 放在專案底下，或做成真正的 pip 套件。

---

## 3. 建立 `stocktech/__init__.py`

```python
# stocktech/__init__.py

from .downloader import download_price_data
from .indicators import add_indicators
from .plotter import plot_with_indicators

__all__ = [
    "download_price_data",
    "add_indicators",
    "plot_with_indicators",
]
```

---

## 4. 建立 `stocktech/config.py`（預設參數）

```python
# stocktech/config.py

DEFAULT_PERIOD = "1y"     # 預設抓 1 年
DEFAULT_INTERVAL = "1d"   # 日線
DEFAULT_MA_WINDOWS = (5, 20, 60)
```

---

## 5. 建立 `stocktech/downloader.py`（自動下載股票資料）

```python
# stocktech/downloader.py

import yfinance as yf
import pandas as pd
from .config import DEFAULT_PERIOD, DEFAULT_INTERVAL


def download_price_data(
    symbol: str,
    start: str | None = None,
    end: str | None = None,
    period: str = DEFAULT_PERIOD,
    interval: str = DEFAULT_INTERVAL,
) -> pd.DataFrame:
    """使用 yfinance 下載股票歷史資料。

    參數
    ------
    symbol : str
        股票代碼，例如：
        - AAPL    (Apple)
        - 2330.TW (台積電)
    start, end : str | None
        起迄日期，格式 'YYYY-MM-DD'，若提供 start/end 則會忽略 period。
    period : str
        yfinance 的 period 參數，例如 '1y', '6mo', '5d' 等。
    interval : str
        yfinance 的 interval 參數，例如 '1d', '1h', '15m' 等。

    回傳
    ------
    df : pandas.DataFrame
        欄位包含：Open, High, Low, Close, Adj Close, Volume
        index 為 DatetimeIndex
    """
    if start or end:
        df = yf.download(symbol, start=start, end=end, interval=interval)
    else:
        df = yf.download(symbol, period=period, interval=interval)

    if df.empty:
        raise ValueError(f"下載不到資料：symbol={symbol}")

    # 確保欄位名稱符合 mplfinance 要求
    df = df[["Open", "High", "Low", "Close", "Volume"]]
    df.index.name = "Date"
    return df
```

---

## 6. 建立 `stocktech/indicators.py`（技術指標計算）

### 6.1 使用 `pandas-ta` 版本（簡潔）

```python
# stocktech/indicators.py

from __future__ import annotations

import pandas as pd
import pandas_ta as ta
from .config import DEFAULT_MA_WINDOWS


def add_indicators(
    df: pd.DataFrame,
    ma_windows: tuple[int, ...] = DEFAULT_MA_WINDOWS,
    use_suffix: bool = False,
) -> pd.DataFrame:
    """在原本的 OHLC DataFrame 上加入常用技術指標欄位。

    - 多條均線 (SMA)
    - EMA
    - MACD (線, 訊號線, 柱狀圖)
    - RSI
    - 布林通道 (BBands)

    回傳加上技術指標的 DataFrame（會回傳新物件，不會就地修改）。
    """
    df = df.copy()

    # 簡單移動平均 (SMA)
    for win in ma_windows:
        col = f"SMA_{win}"
        df[col] = df["Close"].rolling(win).mean()

    # EMA（示範 12, 26）
    df["EMA_12"] = df["Close"].ewm(span=12, adjust=False).mean()
    df["EMA_26"] = df["Close"].ewm(span=26, adjust=False).mean()

    # MACD（利用 pandas-ta）
    macd = ta.macd(df["Close"], fast=12, slow=26, signal=9)
    df["MACD"] = macd["MACD_12_26_9"]
    df["MACD_SIGNAL"] = macd["MACDs_12_26_9"]
    df["MACD_HIST"] = macd["MACDh_12_26_9"]

    # RSI（14）
    df["RSI_14"] = ta.rsi(df["Close"], length=14)

    # 布林通道（20）
    bbands = ta.bbands(df["Close"], length=20, std=2)
    df["BB_UPPER"] = bbands["BBU_20_2.0"]
    df["BB_MIDDLE"] = bbands["BBM_20_2.0"]
    df["BB_LOWER"] = bbands["BBL_20_2.0"]

    return df
```

### 6.2 不用 `pandas-ta`（手刻版本，擔心安裝問題用這段就好）

```python
# stocktech/indicators.py 另一種版本（不依賴 pandas-ta）

from __future__ import annotations
import pandas as pd
from .config import DEFAULT_MA_WINDOWS


def _rsi(series: pd.Series, period: int = 14) -> pd.Series:
    delta = series.diff()

    up = delta.clip(lower=0)
    down = -delta.clip(upper=0)

    gain = up.rolling(period).mean()
    loss = down.rolling(period).mean()

    rs = gain / loss
    rsi = 100 - (100 / (1 + rs))
    return rsi


def _bbands(series: pd.Series, window: int = 20, num_std: float = 2.0):
    ma = series.rolling(window).mean()
    std = series.rolling(window).std()

    upper = ma + num_std * std
    lower = ma - num_std * std
    return upper, ma, lower


def add_indicators(
    df: pd.DataFrame,
    ma_windows: tuple[int, ...] = DEFAULT_MA_WINDOWS,
) -> pd.DataFrame:
    df = df.copy()

    # SMA
    for win in ma_windows:
        df[f"SMA_{win}"] = df["Close"].rolling(win).mean()

    # EMA
    df["EMA_12"] = df["Close"].ewm(span=12, adjust=False).mean()
    df["EMA_26"] = df["Close"].ewm(span=26, adjust=False).mean()

    # MACD
    df["MACD"] = df["EMA_12"] - df["EMA_26"]
    df["MACD_SIGNAL"] = df["MACD"].ewm(span=9, adjust=False).mean()
    df["MACD_HIST"] = df["MACD"] - df["MACD_SIGNAL"]

    # RSI
    df["RSI_14"] = _rsi(df["Close"], period=14)

    # BBands
    upper, middle, lower = _bbands(df["Close"], window=20, num_std=2)
    df["BB_UPPER"] = upper
    df["BB_MIDDLE"] = middle
    df["BB_LOWER"] = lower

    return df
```

> 你可以二選一實作 `add_indicators`，依照你是否想安裝 `pandas-ta` 而定。

---

## 7. 建立 `stocktech/plotter.py`（整合 K 線 + 技術指標）

```python
# stocktech/plotter.py

from __future__ import annotations

import mplfinance as mpf
import pandas as pd
from typing import Iterable


def plot_with_indicators(
    df: pd.DataFrame,
    symbol: str = "",
    show_ma: bool = True,
    ma_windows: Iterable[int] = (5, 20, 60),
    show_bbands: bool = True,
    show_rsi: bool = True,
    show_macd: bool = True,
    volume: bool = True,
    savefig: str | None = None,
    style: str = "yahoo",
):
    """使用 mplfinance 畫出：
    - K 線 + 均線
    - 布林通道 (BBands)
    - RSI (子圖)
    - MACD (子圖)
    - 交易量

    需要 df 已經經過 add_indicators() 處理。
    """
    addplots = []

    # 布林通道
    if show_bbands and all(col in df.columns for col in ["BB_UPPER", "BB_MIDDLE", "BB_LOWER"]):
        addplots += [
            mpf.make_addplot(df["BB_UPPER"], color="blue"),
            mpf.make_addplot(df["BB_LOWER"], color="blue"),
        ]

    # 均線
    mav = None
    if show_ma:
        mav = tuple(ma_windows)

    # RSI 子圖
    panel_index = 1
    rsi_panel = None
    macd_panel = None

    if show_rsi and "RSI_14" in df.columns:
        rsi_panel = panel_index
        addplots.append(
            mpf.make_addplot(
                df["RSI_14"],
                panel=rsi_panel,
                color="purple",
                ylabel="RSI",
            )
        )
        panel_index += 1

    # MACD 子圖
    if show_macd and all(col in df.columns for col in ["MACD", "MACD_SIGNAL", "MACD_HIST"]):
        macd_panel = panel_index
        addplots.append(
            mpf.make_addplot(
                df["MACD"],
                panel=macd_panel,
                color="blue",
                ylabel="MACD",
            )
        )
        addplots.append(
            mpf.make_addplot(
                df["MACD_SIGNAL"],
                panel=macd_panel,
                color="orange",
            )
        )
        addplots.append(
            mpf.make_addplot(
                df["MACD_HIST"],
                type="bar",
                panel=macd_panel,
                alpha=0.4,
            )
        )
        panel_index += 1

    # panel 比例
    num_panels = panel_index
    # 最上面主圖給較大比例
    if num_panels == 1:
        panel_ratios = (3,)
    elif num_panels == 2:
        panel_ratios = (3, 1)
    elif num_panels == 3:
        panel_ratios = (3, 1, 1)
    else:
        panel_ratios = (3,) + tuple(1 for _ in range(num_panels - 1))

    title = f"{symbol} - Price & Indicators" if symbol else "Price & Indicators"

    mpf.plot(
        df,
        type="candle",
        mav=mav,
        addplot=addplots if addplots else None,
        volume=volume,
        style=style,
        title=title,
        panel_ratios=panel_ratios,
        savefig=savefig,
    )
```

---

## 8. 建立 `stocktech/cli.py`（命令列入口）

```python
# stocktech/cli.py

from __future__ import annotations

import argparse

from .downloader import download_price_data
from .indicators import add_indicators
from .plotter import plot_with_indicators


def main():
    parser = argparse.ArgumentParser(
        description="自動下載股票資料並畫出技術指標圖（mplfinance）"
    )
    parser.add_argument("symbol", type=str, help="股票代碼，例如 AAPL 或 2330.TW")
    parser.add_argument("--start", type=str, default=None, help="起始日期 YYYY-MM-DD")
    parser.add_argument("--end", type=str, default=None, help="結束日期 YYYY-MM-DD")
    parser.add_argument("--period", type=str, default="1y", help="yfinance period, e.g. 1y, 6mo")
    parser.add_argument("--interval", type=str, default="1d", help="yfinance interval, e.g. 1d, 1h")
    parser.add_argument("--no-ma", action="store_true", help="關閉均線顯示")
    parser.add_argument("--no-bbands", action="store_true", help="關閉布林通道顯示")
    parser.add_argument("--no-rsi", action="store_true", help="關閉 RSI 子圖")
    parser.add_argument("--no-macd", action="store_true", help="關閉 MACD 子圖")
    parser.add_argument("--savefig", type=str, default=None, help="將圖檔儲存為檔名 (PNG)")
    args = parser.parse_args()

    df = download_price_data(
        symbol=args.symbol,
        start=args.start,
        end=args.end,
        period=args.period,
        interval=args.interval,
    )

    df = add_indicators(df)

    plot_with_indicators(
        df,
        symbol=args.symbol,
        show_ma=not args.no_ma,
        show_bbands=not args.no_bbands,
        show_rsi=not args.no_rsi,
        show_macd=not args.no_macd,
        savefig=args.savefig,
    )


if __name__ == "__main__":
    main()
```

---

## 9. 在專案中使用這個套件

### 9.1 直接在 Python 腳本中使用

假設你的專案結構：

```text
your_project/
    main.py
    stocktech/
        __init__.py
        config.py
        downloader.py
        indicators.py
        plotter.py
        cli.py
```

`main.py` 範例：

```python
from stocktech import download_price_data, add_indicators, plot_with_indicators

if __name__ == "__main__":
    symbol = "2330.TW"  # 台積電
    df = download_price_data(symbol, period="6mo")
    df = add_indicators(df)
    plot_with_indicators(df, symbol=symbol, savefig="2330_tech.png")
```

執行：

```bash
python main.py
```

會自動下載台積電近六個月資料，計算技術指標並輸出一張 `2330_tech.png` 圖片。

---

### 9.2 以模組方式呼叫 CLI

在 `your_project` 底下執行：

```bash
python -m stocktech.cli 2330.TW --period 1y --savefig 2330_1y.png
```

或畫美股：

```bash
python -m stocktech.cli AAPL --start 2024-01-01 --end 2024-12-31
```

可加上選項關閉某些技術指標：

```bash
python -m stocktech.cli AAPL --period 6mo --no-rsi --no-macd
```

---

## 10. 延伸功能建議

你可以在這個基礎上擴充：

1. **加入 KD / Stochastic Oscillator**
2. **加入 VWAP、OBV、ADX、CCI 等更進階指標**
3. **與資料庫整合（例如 SQLite/PostgreSQL）做歷史快取**
4. **包裝成真正的 pip 套件（使用 `pyproject.toml` 或 `setup.cfg`）**
5. **加入簡易 backtest（例如突破均線買賣）並標在圖上**

---

## 11. 範例：加入買賣訊號標記（延伸）

以下為延伸示例，你可以放在 `plotter.py` 或是另外寫函式，當收盤價向上突破 20 日均線視為「買進」，跌破視為「賣出」，在圖上標註。

```python
import numpy as np
import mplfinance as mpf
import pandas as pd


def add_ma_cross_signals(df: pd.DataFrame, ma_col: str = "SMA_20"):
    """簡單範例：
    - Close 從下往上突破 SMA_20 -> 買進訊號
    - Close 從上往下跌破 SMA_20 -> 賣出訊號
    回傳兩個 Series：buy_price, sell_price，只在訊號當天填入價位。
    """
    close = df["Close"]
    ma = df[ma_col]

    prev_close = close.shift(1)
    prev_ma = ma.shift(1)

    buy_signal = (prev_close < prev_ma) & (close > ma)
    sell_signal = (prev_close > prev_ma) & (close < ma)

    buy_price = np.where(buy_signal, df["Low"] * 0.99, float("nan"))
    sell_price = np.where(sell_signal, df["High"] * 1.01, float("nan"))

    return pd.Series(buy_price, index=df.index), pd.Series(sell_price, index=df.index)


def plot_with_signals(df: pd.DataFrame, symbol: str = ""):
    buy_price, sell_price = add_ma_cross_signals(df, ma_col="SMA_20")

    apds = [
        mpf.make_addplot(df["SMA_20"], color="orange"),
        mpf.make_addplot(buy_price, type="scatter", marker="^", markersize=80, color="green"),
        mpf.make_addplot(sell_price, type="scatter", marker="v", markersize=80, color="red"),
    ]

    mpf.plot(
        df,
        type="candle",
        addplot=apds,
        volume=True,
        style="yahoo",
        title=f"{symbol} - MA20 Cross Signals" if symbol else "MA20 Cross Signals",
    )
```

---

## 12. 總結

透過這個小型 `stocktech` 套件，你可以：

- 一行指令自動下載股票資料（美股 / 台股皆可，只要 Yahoo Finance 有代碼）。  
- 自動計算常見技術指標：`MA/EMA/MACD/RSI/BBands`。  
- 使用 `mplfinance` 一次畫出：  
  - K 線 + 均線  
  - 布林通道  
  - RSI 子圖  
  - MACD 子圖  
  - 交易量  
- 可以在程式內匯入使用，也可用 `python -m stocktech.cli ...` 當作小工具。

你可以直接將這份教學檔案存成 `stocktech_mplfinance_tutorial.md`，  
之後在 VSCode、Jupyter、Obsidian 裡打開，就能當作自己的技術分析模板。

---

（完）
